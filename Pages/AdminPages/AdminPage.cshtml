@page
@model CorporateRiskManagementSystem.Frontend.Pages.AuditorPages.ReportPage
@{
    ViewData["Title"] = "Страница админа";
    string usernameId = ViewData["username"] as string;
}
<h2>Страница админа</h2>

<h3>Выберите пользователя</h3>
<select id="userComboBox" class="form-select">
    <option selected disabled>Загрузка...</option>
</select>

<!-- Форма для редактирования информации пользователя -->
<div id="userEditForm" style="display: none;" class="mt-4">
    <h3>Редактировать пользователя</h3>

    <div class="mb-3">
        <label for="fullNameInput" class="form-label">ФИО:</label>
        <input type="text" id="fullNameInput" class="form-control">
    </div>

    <div class="mb-3">
        <label for="usernameInput" class="form-label">Имя пользователя:</label>
        <input type="text" id="usernameInput" class="form-control">
    </div>

    <div class="mb-3">
        <label for="emailInput" class="form-label">Email:</label>
        <input type="email" id="emailInput" class="form-control">
    </div>

    <div class="mb-3">
        <label for="roleComboBox" class="form-label">Роль:</label>
        <select id="roleComboBox" class="form-select">
            <option value="Auditor">Аудитор</option>
            <option value="Administrator">Администратор</option>
            <option value="Manager">Директор</option>
        </select>
    </div>

    <button id="updateUserBtn" class="btn btn-primary">Сохранить изменения</button>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function () {
            const comboBox = $('#userComboBox');
            const userEditForm = $('#userEditForm');
            const updateUserBtn = $('#updateUserBtn');
            const updateRoleBtn = $('#updateRoleBtn');

            let selectedUserId = null;
            let originalUserData = null;

            // Загрузка списка пользователей
            comboBox.empty();
            $.ajax({
                url: 'https://localhost:7248/Admin/GetUserName',
                type: 'GET',
                success: function (users) {
                    comboBox.append($('<option>', {
                        value: '',
                        text: 'Выберите пользователя',
                        disabled: true,
                        selected: true
                    }));

                    users.forEach(function (user) {
                        comboBox.append($('<option>', {
                            value: user.trim().split(' ').at(-1), // email как значение
                            text: user
                        }));
                    });
                },
                error: function (xhr, status, error) {
                    comboBox.append($('<option>', {
                        text: 'Ошибка загрузки данных'
                    }));
                    Swal.fire('Ошибка', 'Ошибка при получении пользователей: ' + error, 'error');
                    console.error('Ошибка при получении пользователей:', xhr.responseText);
                }
            });

            // Обработка выбора пользователя
            comboBox.change(async function () {
                const email = $(this).val();
                if (!email) {
                    userEditForm.hide();
                    selectedUserId = null;
                    originalUserData = null;
                    return;
                }

                try {
                    // Получаем ID пользователя
                    const idRes = await fetch(`https://localhost:7248/Admin/GetUserIdByEmail?email=${encodeURIComponent(email)}`);
                    if (idRes.ok) {
                        const idData = await idRes.json();
                        selectedUserId = idData.userId;

                        // Получаем полные данные пользователя (нужно добавить эндпоинт)
                        const userRes = await fetch(`https://localhost:7248/Admin/GetUserById?id=${selectedUserId}`);
                        if (userRes.ok) {
                            const userData = await userRes.json();
                            originalUserData = userData;

                            // Заполняем форму данными
                            $('#fullNameInput').val(userData.fullName || '');
                            $('#usernameInput').val(userData.username || '');
                            $('#emailInput').val(userData.email || '');
                            $('#roleComboBox').val(userData.role || 'Auditor');

                            // Показываем форму
                            userEditForm.show();
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Ошибка',
                                text: 'Не удалось загрузить данные пользователя',
                            });
                        }
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Ошибка',
                            text: 'Не удалось получить ID пользователя',
                        });
                    }
                } catch (e) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Сетевая ошибка',
                        text: 'Ошибка при получении данных',
                    });
                }
            });

            // Обработка сохранения всех изменений
            updateUserBtn.click(async function () {
                if (!selectedUserId) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Внимание',
                        text: 'Пользователь не выбран',
                    });
                    return;
                }

                const userData = {
                    userId: selectedUserId,
                    fullName: $('#fullNameInput').val(),
                    username: $('#usernameInput').val(),
                    email: $('#emailInput').val(),
                    role: $('#roleComboBox').val()
                };

                try {
                    const response = await fetch('https://localhost:7248/Admin/UpdateUser', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData)
                    });

                    if (response.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Готово',
                            text: 'Данные пользователя успешно обновлены',
                        });

                        // Обновляем список пользователей
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        const msg = await response.text();
                        Swal.fire({
                            icon: 'error',
                            title: 'Ошибка',
                            text: msg,
                        });
                    }
                } catch (e) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Ошибка',
                        text: 'Ошибка при обновлении данных пользователя',
                    });
                }
            });

            // Обработка изменения только роли
            updateRoleBtn.click(async function () {
                if (!selectedUserId) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Внимание',
                        text: 'Пользователь не выбран',
                    });
                    return;
                }

                const role = $('#roleComboBox').val();

                try {
                    const response = await fetch('https://localhost:7248/Admin/ChangeUserRole', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: selectedUserId, newRole: role })
                    });

                    if (response.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Готово',
                            text: 'Роль успешно обновлена',
                        });
                    } else {
                        const msg = await response.text();
                        Swal.fire({
                            icon: 'error',
                            title: 'Ошибка',
                            text: msg,
                        });
                    }
                } catch (e) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Ошибка',
                        text: 'Ошибка при запросе на изменение роли',
                    });
                }
            });
        });
    </script>
}