@page
@using Microsoft.AspNetCore.Identity
@model IndexModel
@{
    ViewData["Title"] = "CRMS";
    string username = ViewData["username"] as string;
}
<style>
    .risk-type-selector {
        margin-bottom: 1rem;
    }

    .risk-type-option {
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .risk-type-card {
        border: 2px solid #dee2e6;
        transition: all 0.3s ease;
        border-radius: 8px;
    }

        .risk-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

    .risk-type-option.selected .risk-type-card {
        border-color: #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }

    .risk-type-icon {
        width: 60px;
        height: 60px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: rgba(13, 110, 253, 0.1);
    }

    .risk-type-option.selected .risk-type-icon {
        background-color: rgba(13, 110, 253, 0.2);
    }
</style>
@if (@User.IsInRole("Auditor"))
{
    <form id="createRiskForm">
        <div class="mb-3">
            <label for="title" class="form-label">Название</label>
            <input type="text" id="title" class="form-control" required />
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">Описание риска</label>
            <textarea id="description" class="form-control" required></textarea>
        </div>

        <!-- Тип риска с красивым отображением -->
        <div class="mb-3">
            <label for="riskType" class="form-label">Тип риска</label>
            <div class="risk-type-selector">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="risk-type-option" data-type="Operational">
                            <div class="card risk-type-card h-100">
                                <div class="card-body text-center">
                                    <div class="risk-type-icon mb-2">
                                        <i class="bi bi-gear-fill text-primary fs-3"></i>
                                    </div>
                                    <h6 class="card-title">Операционный</h6>
                                    <p class="card-text small text-muted">Сбои в работе оборудования, проблемы с поставками, ошибки в управлении запасами</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="risk-type-option" data-type="Financial">
                            <div class="card risk-type-card h-100">
                                <div class="card-body text-center">
                                    <div class="risk-type-icon mb-2">
                                        <i class="bi bi-cash-coin text-success fs-3"></i>
                                    </div>
                                    <h6 class="card-title">Финансовый</h6>
                                    <p class="card-text small text-muted">Проблемы с ликвидностью, нехватка финансирования, ошибки в управлении кредитным портфелем</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="risk-type-option" data-type="Legal">
                            <div class="card risk-type-card h-100">
                                <div class="card-body text-center">
                                    <div class="risk-type-icon mb-2">
                                        <i class="bi bi-scale-balanced text-warning fs-3"></i>
                                    </div>
                                    <h6 class="card-title">Юридический</h6>
                                    <p class="card-text small text-muted">Судебные иски, нарушения законодательства, нарушение авторских прав</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="risk-type-option" data-type="Reputational">
                            <div class="card risk-type-card h-100">
                                <div class="card-body text-center">
                                    <div class="risk-type-icon mb-2">
                                        <i class="bi bi-star-fill text-info fs-3"></i>
                                    </div>
                                    <h6 class="card-title">Репутационный</h6>
                                    <p class="card-text small text-muted">Ущерб деловой репутации из-за действий сотрудников или внешних событий</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="risk-type-option" data-type="HumanResources">
                            <div class="card risk-type-card h-100">
                                <div class="card-body text-center">
                                    <div class="risk-type-icon mb-2">
                                        <i class="bi bi-people-fill text-danger fs-3"></i>
                                    </div>
                                    <h6 class="card-title">Кадровый</h6>
                                    <p class="card-text small text-muted">Некомпетентность сотрудников, недобросовестность, мошенничество</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="risk-type-option" data-type="Technological">
                            <div class="card risk-type-card h-100">
                                <div class="card-body text-center">
                                    <div class="risk-type-icon mb-2">
                                        <i class="bi bi-cpu-fill text-secondary fs-3"></i>
                                    </div>
                                    <h6 class="card-title">Технологический</h6>
                                    <p class="card-text small text-muted">Технические сбои, устаревание технологий, проблемы с безопасностью данных</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Скрытый input для хранения выбранного значения -->
                <input type="hidden" id="riskType" name="riskType" value="Operational" required />
            </div>
            <div class="form-text">Выберите тип риска, кликнув на соответствующую карточку</div>
        </div>

        <div class="mb-3">
            <label for="severity" class="form-label">Серьезность</label>
            <img src="~/images/icon/auditor/severity.png" alt="audit icon" width="24" height="24" class="ms-2" />
            <select id="severity" class="form-select" required>
                <option value="Low">Низкий</option>
                <option value="Medium">Средний</option>
                <option value="High">Высокий</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="likelihood" title="Вероятность описывает степень вероятности наступления данного риска в рамках определённого периода времени или условий" class="form-label">Вероятность</label>
            <img src="~/images/icon/auditor/likehood.png" alt="audit icon" width="24" height="24" class="ms-2" />
            <select id="likelihood" class="form-select" required>
                <option title="Риск маловероятен и вряд ли случится в обозримом будущем. Возможно, только в случае некоторых нестандартных или уникальных обстоятельств." value="Low">Низкий</option>
                <option title="Риск может случиться, но в ограниченном объёме или при определённых условиях. Требуется внимание и мониторинг, но не является критичным на данный момент" value="Medium">Средний</option>
                <option title="Риск имеет значительную вероятность проявления в ближайшем будущем и требует немедленного внимания. Это риски, которые могут существенно повлиять на работу организации" value="High">Высокий</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Создать риск</button>
    </form>
}
@if (@User.IsInRole("Manager"))
{
         <div class="role-section mb-5">
         <div class="section-header mb-4">
             <h3 class="text-dark">
                 <i class="fas fa-chart-line text-warning me-2"></i>
                 Руководство для директора/ответственного за устранение потенциальных рисков
             </h3>
             <p class="text-muted">Инструменты для мониторинга и контроля рисков</p>
         </div>

         <div class="row g-4">
             <div class="col-md-6">
                 <div class="feature-card h-100">
                     <div class="feature-icon bg-warning">
                         <i class="fas fa-eye"></i>
                     </div>
                     <h5>Просмотр отчетов</h5>
                     <p class="text-muted">Анализируйте готовые аудиторские отчеты по отделам. Отслеживайте выполнение планов по снижению рисков.</p>
                     <a href="/ManagerPages/ManagerPage" class="btn btn-outline-warning btn-sm">
                         <i class="fas fa-arrow-right me-1"></i> Перейти к отчетам
                     </a>
                 </div>
             </div>

             <div class="col-md-6">
                 <div class="feature-card h-100">
                     <div class="feature-icon bg-success">
                         <i class="fas fa-tasks"></i>
                     </div>
                     <h5>Управление рисками</h5>
                     <p class="text-muted">Контролируйте статусы всех рисков, изменяйте приоритеты, отслеживайте прогресс исправлений.</p>
                     <a href="/ManagerPages/ManagerRiskPage" class="btn btn-outline-success btn-sm">
                         <i class="fas fa-arrow-right me-1"></i> Управление рисками
                     </a>
                 </div>
             </div>
         </div>

         <div class="quick-guide mt-4">
             <h6 class="text-dark mb-3"><i class="fas fa-lightbulb me-2"></i>Быстрый старт:</h6>
             <ol class="list-group list-group-numbered">
                <li class="list-group-item border-0 bg-transparent">
                    <strong>Перейдите к просмотру отчётов</strong> для отображения списка рисков
                </li>
                 <li class="list-group-item border-0 bg-transparent">
                     <strong>Выберите отдел</strong> для анализа в верхнем меню
                 </li>
                 <li class="list-group-item border-0 bg-transparent">
                    <strong>Просмотрите потенциальные риски подразделении</strong>, выявленных аудиторами по выбранному отделу
                 </li>
                 <li class="list-group-item border-0 bg-transparent">
                     <strong>Измените статусы рисков</strong> на "Завершен" или "Отменен" после исправления
                 </li>
             </ol>
         </div>
     </div>
}
@if (@User.IsInRole("Administrator"))
{
     <div class="role-section">
     <div class="section-header mb-4">
         <h3 class="text-dark">
             <i class="fas fa-cogs text-danger me-2"></i>
             Панель администратора
         </h3>
         <p class="text-muted">Управление пользователями и настройка системы</p>
     </div>

     <div class="row g-4">
         <div class="col-md-4">
             <div class="feature-card h-100">
                 <div class="feature-icon bg-danger">
                     <i class="fas fa-users-cog"></i>
                 </div>
                 <h5>Управление пользователями</h5>
                 <p class="text-muted">Добавляйте новых сотрудников, изменяйте роли и права доступа. Контролируйте активность пользователей.</p>
                 <a href="/AdminPages/AdminPage" class="btn btn-outline-danger btn-sm">
                     <i class="fas fa-arrow-right me-1"></i> Управление пользователями
                 </a>
             </div>
         </div>
     </div>

     <div class="alert alert-warning mt-4">
         <h6 class="alert-heading">
             <i class="fas fa-exclamation-triangle me-2"></i>Важно для администратора:
         </h6>
         <ul class="mb-0">
             <li>Регулярно проверяйте активность пользователей</li>
             <li>Назначайте роли в соответствии с должностными инструкциями</li>
             <li>Своевременно деактивируйте учетные записи уволенных сотрудников</li>
             <li>Резервируйте данные системы еженедельно</li>
         </ul>
     </div>
 </div>
}
<style>
    .system-icon {
        color: #4361ee;
        opacity: 0.8;
    }

    .user-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .role-section {
        animation: fadeIn 0.5s ease;
    }

    .section-header {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 1rem;
    }

    .feature-card {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 1.5rem;
        transition: all 0.3s ease;
    }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: #4361ee;
        }

    .feature-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.25rem;
        margin-bottom: 1rem;
    }

    .quick-guide {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
    }

    .list-group-item {
        padding-left: 0.5rem;
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
    }
</style>
@section Scripts {
    <!-- Подключаем Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <script>
        $(document).ready(function () {
            // Загрузка департаментов при загрузке страницы
            const departmentId = localStorage.getItem('selectedDepartment');

            if (!departmentId) {
                Swal.fire('Ошибка', 'Не выбран отдел.', 'error');
                return;
            }

            // Обработчик выбора типа риска
            $('.risk-type-option').on('click', function () {
                // Убираем класс selected у всех карточек
                $('.risk-type-option').removeClass('selected');

                // Добавляем класс selected к выбранной карточке
                $(this).addClass('selected');

                // Устанавливаем значение в скрытом input
                const riskType = $(this).data('type');
                $('#riskType').val(riskType);

                console.log('Выбран тип риска:', riskType);
            });

            // Выбираем первый тип риска по умолчанию
            $('.risk-type-option').first().addClass('selected');

 
            // Обработчик отправки формы
            $("#createRiskForm").on("submit", function (event) {
                event.preventDefault();

                const data = {
                    title: $("#title").val(),
                    description: $("#description").val(),
                    riskType: $("#riskType").val(), // Добавляем тип риска
                    severity: $("#severity").val(),
                    likelihood: $("#likelihood").val(),
                    departmentId: $("#departmentDropdown").val(),
                    usernameId: "@ViewData["username"].ToString()"
                };

                console.log('Данные для отправки:', data);

                // Проверяем, что выбран департамент
                if (!data.departmentId) {
                    Swal.fire('Внимание', 'Пожалуйста, выберите департамент', 'warning');
                    return;
                }

                // Отправка данных на сервер
                fetch('https://localhost:7248/Risk/CreateRisk', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.message || 'Ошибка при создании риска'); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        Swal.fire({
                            title: 'Готово!',
                            text: 'Риск успешно создан',
                            icon: 'success',
                            confirmButtonText: 'ОК'
                        }).then(() => {
                            // Сбрасываем форму
                            $("#createRiskForm")[0].reset();
                            // Сбрасываем выбор типа риска
                            $('.risk-type-option').removeClass('selected');
                            $('.risk-type-option').first().addClass('selected');
                            $('#riskType').val('Operational');
                            // Перезагрузка страницы
                            location.reload();
                        });
                    })
                    .catch(error => {
                        console.error('Ошибка:', error);
                        Swal.fire('Ошибка', error.message || 'Не удалось создать риск', 'error');
                    });
            });
        });
    </script>

    @Html.AntiForgeryToken()
}